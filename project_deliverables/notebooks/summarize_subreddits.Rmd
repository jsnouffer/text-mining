---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.1'
      jupytext_version: 1.2.3
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

```{python}
import json
from elasticsearch import Elasticsearch
from elasticsearch import helpers
scan = helpers.scan

es = Elasticsearch([{'host':'localhost','port':9200}])
es
```

```{python}
results = scan(es, query = 
{
  "query": {
    "bool": {
      "must": [
        {
          "exists": {
            "field": "bm.overall"
          }
        }
      ]
    }
  }
}, index = 'redditors')

all_keys = set()
summary = {}
count = 0
for result in results:
    count = count + 1
    if count % 5000 == 0:
        print(count)
    
    doc = result['_source']
    mbti = doc['bm']['overall']
    
    for subreddit in doc['subreddits']:
        if subreddit not in summary.keys():
            summary[subreddit] = {
                "count": 0
            }
            
        summary[subreddit]['count'] = summary[subreddit]['count'] + 1
    
        for key in mbti.keys():
            if key == 'type':
                key = mbti['type']
            
            all_keys.add(key)
            if key in summary[subreddit]:
                summary[subreddit][key]['count'] = summary[subreddit][key]['count'] + 1
            else:
                summary[subreddit][key] = { "count": 0 }
```

```{python}
all_keys
```

```{python}
for name in summary:
    subreddit = summary[name]
    
    for key in subreddit:
        if isinstance(subreddit[key], dict):
            subreddit[key]["percent"] = (subreddit[key]["count"] / subreddit["count"]) * 100.0
    
    for key in all_keys:
        if key not in subreddit.keys():
            subreddit[key] = { "count": 0, "percent": 0.0}
```

```{python}
l = list()

for name in summary:
    summary[name]['name'] = name
    l.append(summary[name])
    
with open('subreddit-summary.json', 'w') as fp:
    json.dump(l, fp)
```

```{python}
l[0]
```
